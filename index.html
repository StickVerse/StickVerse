<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#00b4ff">
    <title>StickVerse - Ultimate Avatar Platform</title>
    <link rel="manifest" href="data:application/manifest+json,{
      \"name\": \"StickVerse\",
      \"short_name\": \"StickVerse\",
      \"start_url\": \".\",
      \"display\": \"standalone\",
      \"background_color\": \"#0a0a0a\",
      \"theme_color\": \"#00b4ff\",
      \"icons\": [{
        \"src\": \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%2300b4ff'/%3E%3Ctext x='50' y='65' font-size='60' text-anchor='middle' fill='white' font-family='Arial'%3ES%3C/text%3E%3C/svg%3E\",
        \"sizes\": \"192x192\",
        \"type\": \"image/svg+xml\"
      }]
    }">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        :root {
            --primary: #00b4ff; --primary-hover: #0094d6; --secondary: #191919;
            --accent: #ff6b35; --success: #00d26a; --dark: #0a0a0a;
            --card-bg: #232527; --card-hover: #2a2d30; --border: #393b3d;
            --text: #ffffff; --text-secondary: #9da1a6; --shadow: rgba(0,0,0,0.4);
        }
        body { background: var(--dark); color: var(--text); overflow-x: hidden; }
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 5px; }
        header { background: var(--secondary); padding: 12px 24px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px var(--shadow); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border); }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-img { width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary), #0094d6); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 24px; color: white; }
        .logo h1 { font-size: 26px; font-weight: 700; background: linear-gradient(135deg, var(--primary), #00d4ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .search-bar { flex: 1; max-width: 500px; margin: 0 24px; position: relative; }
        .search-bar input { width: 100%; padding: 12px 16px; border-radius: 8px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text); }
        .search-bar input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,180,255,0.1); }
        .user-actions { display: flex; gap: 12px; align-items: center; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), #0094d6); color: white; box-shadow: 0 4px 12px rgba(0,180,255,0.3); }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-secondary { background: var(--card-bg); color: var(--text); border: 1px solid var(--border); }
        .btn-logout { background: var(--accent); color: white; }
        .currency-display { display: flex; align-items: center; gap: 8px; background: var(--card-bg); padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border); font-weight: 600; }
        .pencil-icon { width: 20px; height: 20px; background: linear-gradient(135deg, #ffd700, #ffed4e); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #000; font-weight: 700; }
        nav { background: var(--secondary); padding: 0 24px; border-bottom: 1px solid var(--border); }
        .nav-tabs { display: flex; list-style: none; gap: 8px; }
        .nav-tabs li { padding: 16px 24px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s; color: var(--text-secondary); }
        .nav-tabs li.active, .nav-tabs li:hover { border-bottom: 3px solid var(--primary); color: var(--primary); background: rgba(0,180,255,0.1); }
        .container { display: flex; min-height: calc(100vh - 130px); }
        .sidebar { width: 280px; background: var(--secondary); padding: 24px; border-right: 1px solid var(--border); }
        .main-content { flex: 1; padding: 24px; background: var(--dark); }
        .content-section { display: none; animation: fadeIn 0.3s; }
        .content-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: none; } }
        .hero-banner { background: linear-gradient(135deg, #00b4ff, #0061ff); padding: 48px; margin-bottom: 24px; text-align: center; border-radius: 16px; box-shadow: 0 8px 24px rgba(0,180,255,0.3); }
        .hero-banner h2 { font-size: 42px; margin-bottom: 12px; }
        .avatar-container { display: flex; gap: 24px; margin-top: 24px; }
        .avatar-viewer { flex: 1; background: var(--card-bg); padding: 32px; border-radius: 16px; text-align: center; border: 1px solid var(--border); }
        .stickman-avatar { width: 200px; height: 300px; position: relative; margin: 0 auto 32px; image-rendering: pixelated; }
        .stickman-head { position: absolute; width: 40px; height: 40px; background: white; border-radius: 50%; top: 10px; left: 80px; }
        .stickman-body { position: absolute; width: 6px; height: 100px; background: white; top: 50px; left: 97px; }
        .stickman-arm-left { position: absolute; width: 60px; height: 6px; background: white; top: 70px; left: 45px; transform: rotate(30deg); }
        .stickman-arm-right { position: absolute; width: 60px; height: 6px; background: white; top: 70px; left: 95px; transform: rotate(-30deg); }
        .stickman-leg-left { position: absolute; width: 60px; height: 6px; background: white; top: 150px; left: 45px; transform: rotate(-30deg); transform-origin: right; }
        .stickman-leg-right { position: absolute; width: 60px; height: 6px; background: white; top: 150px; left: 95px; transform: rotate(30deg); transform-origin: left; }
        .accessory { position: absolute; display: none; pointer-events: none; }
        .accessory.visible { display: block; }
        .accessories-panel { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .acc-item { aspect-ratio: 1; background: var(--secondary); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; position: relative; overflow: hidden; }
        .acc-item:hover { border-color: var(--primary); transform: scale(1.05); }
        .acc-item.selected { border-color: var(--accent); background: rgba(255,107,53,0.2); }
        .delete-acc { position: absolute; top: 4px; right: 4px; width: 20px; height: 20px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; display: none; }
        .acc-item:hover .delete-acc { display: block; }
        .wearing-item { position: relative; }
        .unequip-btn { position: absolute; top: 4px; right: 4px; width: 20px; height: 20px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 12px; }
        .notification { position: fixed; top: 24px; right: 24px; background: var(--card-bg); padding: 16px 20px; border-left: 4px solid var(--primary); border-radius: 8px; box-shadow: 0 8px 24px var(--shadow); z-index: 1001; max-width: 320px; opacity: 0; transform: translateX(100%); transition: all 0.3s; }
        .notification.show { opacity: 1; transform: none; }
        .notification.success { border-left-color: var(--success); }
        .notification.error { border-left-color: #dc3545; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: var(--card-bg); width: 420px; max-width: 90%; padding: 32px; border-radius: 16px; border: 1px solid var(--border); position: relative; }
        .close-modal { position: absolute; top: 16px; right: 16px; background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 12px 16px; background: var(--secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text); }
        @media (max-width: 768px) { .avatar-container { flex-direction: column; } .container { flex-direction: column; } .sidebar { width: 100%; } }
    </style>
</head>
<body>
    <div class="notification" id="notif"></div>

    <header>
        <div class="logo">
            <div class="logo-img">S</div>
            <h1>StickVerse</h1>
        </div>
        <div class="search-bar">
            <input type="text" id="search" placeholder="Search users or paste code...">
            <div class="search-results" id="results"></div>
        </div>
        <div class="user-actions" id="userActions">
            <button class="btn btn-secondary" id="loginBtn">Log In</button>
            <button class="btn btn-primary" id="signupBtn">Sign Up</button>
        </div>
    </header>

    <nav>
        <ul class="nav-tabs">
            <li class="active" data-tab="home">Home</li>
            <li data-tab="avatar">Avatar</li>
            <li data-tab="profile">Profile</li>
        </ul>
    </nav>

    <div class="container">
        <div class="sidebar">
            <h3>Friends Online</h3>
            <div id="friendsList">No friends yet</div>
        </div>

        <div class="main-content">
            <div class="content-section active" id="home">
                <div class="hero-banner">
                    <h2>Welcome to StickVerse</h2>
                    <p>Create, share, and wear pixel accessories with friends!</p>
                    <button class="btn btn-primary" id="exportBtn">Export Avatar as PNG</button>
                </div>
            </div>

            <div class="content-section" id="avatar">
                <h2>Avatar Creator</h2>
                <div class="avatar-container">
                    <div class="avatar-viewer">
                        <div class="stickman-avatar" id="avatarPreview">
                            <div class="stickman-head"></div>
                            <div class="stickman-body"></div>
                            <div class="stickman-arm-left"></div>
                            <div class="stickman-arm-right"></div>
                            <div class="stickman-leg-left"></div>
                            <div class="stickman-leg-right"></div>
                            <div class="accessory" id="hatLayer"></div>
                            <div class="accessory" id="faceLayer"></div>
                            <div class="accessory" id="shirtLayer"></div>
                            <div class="accessory" id="pantsLayer"></div>
                            <div class="accessory" id="glassesLayer"></div>
                        </div>
                        <button class="btn btn-primary" id="saveAvatarBtn">Save Avatar</button>
                        <button class="btn btn-primary" id="exportBtn2">Export as PNG</button>
                    </div>

                    <div class="accessories-panel">
                        <h3>My Accessories <span style="font-size:12px;color:#888">(Click to equip)</span></h3>
                        <div class="accessories" id="myAccessories"></div>

                        <div style="margin-top:32px;padding:20px;background:var(--card-bg);border-radius:12px;">
                            <h3>Create New</h3>
                            <select id="accType">
                                <option value="hat">Hat</option>
                                <option value="face">Face</option>
                                <option value="shirt">Shirt</option>
                                <option value="pants">Pants</option>
                                <option value="glasses">Glasses</option>
                            </select>
                            <input type="text" id="accName" placeholder="Name" style="width:100%;margin:10px 0;padding:10px;border-radius:8px;border: 1px solid var(--border);background:var(--secondary);color:white;">
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                                <button class="btn btn-primary" id="createAccBtn">Create (50 Pencils)</button>
                                <button class="btn btn-secondary" id="importCodeBtn">Import from Code</button>
                            </div>
                            <textarea id="shareCode" placeholder="Paste code here to import..." style="width:100%;height:80px;margin-top:12px;padding:10px;border-radius:8px;background:var(--secondary);color:white;"></textarea>
                            <button class="btn btn-secondary" style="width:100%;margin-top:8px;" onclick="copyShareCode()">Copy My Code</button>
                        </div>

                        <canvas id="canvas" width="400" height="400" style="display:none;"></canvas>
                    </div>
                </div>
            </div>

            <div class="content-section" id="profile">
                <h2 id="profileName">Not Logged In</h2>
                <div style="display:flex;gap:20px;flex-wrap:wrap;">
                    <div style="background:var(--card-bg);padding:20px;border-radius:12px;">
                        <strong>Pencils:</strong> <span id="pencilCount">1000</span>
                    </div>
                    <div style="background:var(--card-bg);padding:20px;border-radius:12px;">
                        <strong>Friends:</strong> <span id="friendCount">0</span>
                    </div>
                </div>
                <h3 style="margin:20px 0 10px;">Wearing</h3>
                <div class="accessories" id="wearingList"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <button class="close-modal">x</button>
            <h2>Login</h2>
            <input type="text" id="loginUser" placeholder="Username"><br><br>
            <input type="password" id="loginPass" placeholder="Password"><br><br>
            <button class="btn btn-primary" id="doLogin">Log In</button>
        </div>
    </div>

    <div class="modal" id="signupModal">
        <div class="modal-content">
            <button class="close-modal">x</button>
            <h2>Sign Up</h2>
            <input type="text" id="regUser" placeholder="Username"><br><br>
            <input type="password" id="regPass" placeholder="Password"><br><br>
            <input type="password" id="regPass2" placeholder="Confirm Password"><br><br>
            <button class="btn btn-primary" id="doSignup">Create Account</button>
        </div>
    </div>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
/* ==== StickVerse Ultimate Edition - 2025 ==== */
const DB = {
    users: JSON.parse(localStorage.getItem('sv_users') || '{}'),
    accessories: JSON.parse(localStorage.getItem('sv_accessories') || '{}'),
    currentUser: localStorage.getItem('sv_current') || null,
    lastLogin: localStorage.getItem('sv_lastlogin') || null
};

let user = DB.currentUser ? DB.users[DB.currentUser] : null;

const sizes = { hat:40, face:40, shirt:60, pants:50, glasses:40 };
let selectedType = 'hat';
let equipped = user?.equipped || {};

function hash(str) {
    let h = 0;
    for(let i=0;i<str.length;i++) h = (h<<5)-h + str.charCodeAt(i) | 0;
    return h.toString(36);
}

function save() {
    localStorage.setItem('sv_users', JSON.stringify(DB.users));
    localStorage.setItem('sv_accessories', JSON.stringify(DB.accessories));
    if (DB.currentUser) localStorage.setItem('sv_current', DB.currentUser);
}

function notify(msg, type = 'info') {
    const n = document.getElementById('notif');
    n.textContent = msg;
    n.className = `notification ${type} show`;
    setTimeout(() => n.className = 'notification', 3000);
}

function updateUI() {
    if (DB.currentUser) {
        document.getElementById('userActions').innerHTML = `
            <div class="currency-display"><div class="pencil-icon">P</div><span id="pencilCount">${user.pencils</span></div>
            <span>Welcome, ${DB.currentUser}!</span>
            <button class="btn btn-logout" onclick="logout()">Log Out</button>`;
        document.getElementById('profileName').textContent = DB.currentUser;
        document.getElementById('pencilCount').textContent = user.pencils;
        document.getElementById('friendCount').textContent = user.friends?.length || 0;
        renderWearing();
        renderMyAccessories();
        checkDailyBonus();
        checkBestDressedBadge();
    }
}

function checkDailyBonus() {
    const today = new Date().toDateString();
    if (DB.lastLogin !== today) {
        user.pencils += 100;
        notify("Daily bonus! +100 Pencils", "success");
        localStorage.setItem('sv_lastlogin', today);
        save();
        updateUI();
    }
}

function checkBestDressedBadge() {
    if (Object.keys(equipped).length >= 4 && !user.badges?.includes("Best Dressed")) {
        user.badges = user.badges || [];
        user.badges.push("Best Dressed");
        user.pencils += 500;
        notify("Best Dressed badge earned! +500 Pencils!", "success");
        save();
    }
}

function logout() {
    if (confirm("Log out?")) {
        DB.currentUser = null;
        localStorage.removeItem('sv_current');
        location.reload();
    }
}

document.getElementById('loginBtn').onclick = () => document.getElementById('loginModal').classList.add('active');
document.getElementById('signupBtn').onclick = () => document.getElementById('signupModal').classList.add('active');

document.querySelectorAll('.close-modal').forEach(b => b.onclick = e => e.target.closest('.modal').classList.remove('active'));

document.getElementById('doLogin').onclick = () => {
    const u = document.getElementById('loginUser').value.trim();
    const p = document.getElementById('loginPass').value;
    if (DB.users[u] && DB.users[u].hash === hash(p)) {
        DB.currentUser = u;
        user = DB.users[u];
        equipped = user.equipped || {};
        localStorage.setItem('sv_current', u);
        document.getElementById('loginModal').classList.remove('active');
        notify("Welcome back!", "success");
        updateUI();
        renderAvatar();
    } else notify("Wrong username or password", "error");
};

document.getElementById('doSignup').onclick = () => {
    const u = document.getElementById('regUser').value.trim();
    const p = document.getElementById('regPass').value;
    const p2 = document.getElementById('regPass2').value;
    if (!u || !p) return notify("Fill all fields", "error");
    if (p !== p2) return notify("Passwords don't match", "error");
    if (DB.users[u]) return notify("Username taken", "error");
    DB.users[u] = {
        hash: hash(p),
        pencils: 1000,
        equipped: {},
        accessories: [],
        friends: [],
        badges: [],
        created: Date.now()
    };
    save();
    notify("Account created! Logging in...", "success");
    DB.currentUser = u;
    user = DB.users[u];
    localStorage.setItem('sv_current', u);
    document.getElementById('signupModal').classList.remove('active');
    updateUI();
    renderAvatar();
};

function renderAvatar() {
    ['hat','face','shirt','pants','glasses'].forEach(t => {
        const el = document.getElementById(t + 'Layer');
        el.innerHTML = '';
        el.classList.remove('visible');
        if (equipped[t]) {
            const data = DB.accessories[equipped[t]];
            if (data) {
                el.classList.add('visible');
                data.pixels.forEach(p => {
                    const px = document.createElement('div');
                    px.style.cssText = `position:absolute;left:${p.x}px;top:${p.y}px;width:${p.s}px;height:${p.s}px;background:${p.c}`;
                    el.appendChild(px);
                });
            }
        }
    });
}

function renderMyAccessories() {
    const list = document.getElementById('myAccessories');
    list.innerHTML = '';
    (user.accessories || []).forEach(id => {
        const data = DB.accessories[id];
        if (!data) return;
        const div = document.createElement('div');
        div.className = 'acc-item';
        if (equipped[data.type] === id) div.classList.add('selected');
        data.pixels.forEach(p => {
            const px = document.createElement('div');
            px.style.cssText = `position:absolute;left:${p.x}px;top:${p.y}px;width:${p.s}px;height:${p.s}px;background:${p.c}`;
            div.appendChild(px);
        });
        div.onclick = () => {
            equipped[data.type] = equipped[data.type] === id ? null : id;
            renderAvatar();
            renderWearing();
            user.equipped = equipped;
            save();
            checkBestDressedBadge();
        };
        const del = document.createElement('button');
        del.className = 'delete-acc';
        del.innerHTML = '×';
        del.onclick = e => {
            e.stopPropagation();
            if (confirm("Delete?")) {
                user.accessories = user.accessories.filter(x => x !== id);
                delete equipped[data.type];
                delete DB.accessories[id];
                renderMyAccessories();
                renderAvatar();
                renderWearing();
                save();
            }
        };
        div.appendChild(del);
        list.appendChild(div);
    });
}

function renderWearing() {
    const list = document.getElementById('wearingList');
    list.innerHTML = '';
    Object.entries(equipped).forEach(([type, id]) => {
        const data = DB.accessories[id];
        if (!data) return;
        const div = document.createElement('div');
        div.className = 'wearing-item';
        data.pixels.forEach(p => {
            const px = document.createElement('div');
            px.style.cssText = `position:absolute;left:${p.x}px;top:${p.y}px;width:${p.s}px;height:${p.s}px;background:${p.c}`;
            div.appendChild(px);
        });
        const btn = document.createElement('button');
        btn.className = 'unequip-btn';
        btn.innerHTML = '×';
        btn.onclick = () => {
            delete equipped[type];
            user.equipped = equipped;
            save();
            renderAvatar();
            renderWearing();
        };
        div.appendChild(btn);
        list.appendChild(div);
    });
}

document.getElementById('createAccBtn').onclick = () => {
    if (user.pencils < 50) return notify("Not enough pencils!", "error");
    const name = document.getElementById('accName').value.trim();
    if (!name) return notify("Enter a name", "error");
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const size = sizes[selectedType];
    canvas.width = canvas.height = size;
    // Simple drawing logic here (you can expand this)
    // For brevity, we assume pixels are collected into an array `pixelArray`
    // In full version you would use a real pixel editor
    const pixelArray = []; // ← you fill this from your editor
    const id = Date.now().toString(36) + Math.random().toString(36);
    DB.accessories[id] = { name, type: selectedType, pixels: pixelArray };
    user.accessories.push(id);
    user.pencils -= 50;
    save();
    notify(`"${name}" created!`);
    renderMyAccessories();
};

// Export to PNG
document.getElementById('exportBtn').onclick = document.getElementById('exportBtn2').onclick = () => {
    html2canvas(document.getElementById('avatarPreview'), {backgroundColor: null}).then(canvas => {
        const a = document.createElement('a');
        a.href = canvas.toDataURL();
        a.download = 'stickverse-avatar.png';
        a.click();
    });
};

function copyShareCode() {
    const code = btoa(JSON.stringify({equipped, accessories: user.accessories.map(id=>DB.accessories[id])}));
    navigator.clipboard.writeText(code);
    notify("Code copied! Share it!", "success");
}

document.getElementById('importCodeBtn').onclick = () => {
    const code = document.getElementById('shareCode').value;
    try {
        const data = JSON.parse(atob(code));
        data.accessories.forEach(acc => {
            const id = Date.now().toString(36)+Math.random().toString(36);
            DB.accessories[id] = acc;
            user.accessories.push(id);
        });
        equipped = data.equipped;
        user.equipped = equipped;
        save();
        renderAvatar();
        renderMyAccessories();
        renderWearing();
        notify("Accessories imported!", "success");
    } catch(e) { notify("Invalid code", "error"); }
};

// Tab switching
document.querySelectorAll('.nav-tabs li').forEach(tab => {
    tab.onclick = () => {
        if (!DB.currentUser && ['avatar','profile'].includes(tab.dataset.tab)) {
            document.getElementById('loginModal').classList.add('active');
            return;
        }
        document.querySelectorAll('.nav-tabs li').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        document.getElementById(tab.dataset.tab).classList.add('active');
    };
});

updateUI();
renderAvatar();
</script>
</body>
</html>
